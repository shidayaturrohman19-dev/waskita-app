{% extends "base.html" %}
{% block title %}
    Admin Panel - Waskita
{% endblock title %}
{% block page_title %}
    Admin Panel
{% endblock page_title %}
{% block breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{{ url_for("dashboard") }}">Home</a>
    </li>
    <li class="breadcrumb-item active">Admin Panel</li>
{% endblock breadcrumb %}
{% block extra_css %}
<style>
/* Dropdown fixes for Role and Status */
.card-body {
    overflow: visible !important;
    position: relative !important;
    z-index: 1 !important;
}

.form-group {
    overflow: visible !important;
    position: relative !important;
    z-index: 2 !important;
}

/* Konsistensi ukuran untuk semua elemen form */
.form-control, .btn {
    height: 38px !important;
    min-height: 38px !important;
    line-height: 1.5 !important;
    padding: 6px 12px !important;
    font-size: 14px !important;
    border-radius: 4px !important;
}

/* Khusus untuk input group */
.input-group .form-control {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
}

.input-group .btn {
    border-top-left-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
    height: 38px !important;
    padding: 6px 12px !important;
}

/* Dropdown styling */
select.form-control {
    position: relative !important;
    z-index: 9999 !important;
    background-color: #fff !important;
    border: 1px solid #ced4da !important;
    appearance: menulist !important;
    -webkit-appearance: menulist !important;
    -moz-appearance: menulist !important;
    height: 38px !important;
    padding: 6px 12px !important;
}

select.form-control:focus {
    border-color: #80bdff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    z-index: 10000 !important;
}

select.form-control option {
    background-color: #fff !important;
    color: #495057 !important;
    padding: 8px 12px !important;
}

/* Button consistency */
.btn-block {
    width: 100% !important;
    height: 38px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* Label spacing */
.invisible-label {
    visibility: hidden !important;
    margin-bottom: 0.5rem !important;
}

/* Enhanced User Management Table Styling */
.user-management-table {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.user-management-table .table {
    margin-bottom: 0;
    font-size: 14px;
}

.user-management-table .table thead th {
    background: #ffffff;
    color: #333333;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.5px;
    border: 1px solid #dee2e6;
    border-bottom: 2px solid #dee2e6;
    padding: 15px 12px;
    vertical-align: middle;
    position: sticky;
    top: 0;
    z-index: 10;
}

.user-management-table .table tbody tr {
    transition: all 0.3s ease;
    border-bottom: 1px solid #e9ecef;
}

.user-management-table .table tbody tr:hover {
    background-color: #f8f9ff;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.user-management-table .table tbody td {
    padding: 12px;
    vertical-align: middle;
    border-top: none;
}

/* Column specific styling */
.user-management-table .table tbody td:first-child {
    font-weight: 600;
    color: #6c757d;
    font-size: 13px;
}

.user-management-table .table tbody td:nth-child(2) {
    font-weight: 600;
    color: #495057;
}

.user-management-table .table tbody td:nth-child(3) {
    color: #6c757d;
    font-size: 13px;
}

/* Badge improvements */
.badge {
    font-size: 11px;
    padding: 6px 10px;
    border-radius: 20px;
    font-weight: 500;
    letter-spacing: 0.3px;
    background: #ffffff !important;
    color: #333333 !important;
    border: 1px solid #dee2e6;
}

.badge.bg-danger {
    background: #ffffff !important;
    color: #dc3545 !important;
    border: 1px solid #dc3545;
}

.badge.bg-primary {
    background: #ffffff !important;
    color: #007bff !important;
    border: 1px solid #007bff;
}

.badge.bg-success {
    background: #ffffff !important;
    color: #28a745 !important;
    border: 1px solid #28a745;
}

.badge.bg-secondary {
    background: #ffffff !important;
    color: #6c757d !important;
    border: 1px solid #6c757d;
}

.badge.bg-info {
    background: #ffffff !important;
    color: #17a2b8 !important;
    border: 1px solid #17a2b8;
}

/* Action buttons styling */
.btn-group .btn {
    margin: 0 1px;
    border-radius: 6px !important;
    padding: 6px 10px;
    font-size: 12px;
    transition: all 0.3s ease;
}

.btn-group .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-sm {
    padding: 6px 10px !important;
    font-size: 12px !important;
    line-height: 1.2 !important;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .user-management-table .table-responsive {
        border-radius: 8px;
    }
    
    .user-management-table .table thead th {
        font-size: 11px;
        padding: 10px 8px;
    }
    
    .user-management-table .table tbody td {
        padding: 8px;
        font-size: 13px;
    }
    
    .btn-group {
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
    }
    
    .btn-group .btn {
        margin: 1px;
        padding: 4px 8px;
        font-size: 11px;
    }
}

/* Empty state styling */
.empty-state {
    padding: 60px 20px;
    text-align: center;
    color: #6c757d;
}

.empty-state i {
    color: #dee2e6;
    margin-bottom: 20px;
}

.empty-state h5 {
    color: #495057;
    margin-bottom: 10px;
    font-weight: 600;
}

.empty-state p {
    color: #6c757d;
    margin-bottom: 0;
}

/* Card header improvements */
.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #dee2e6;
}

.card-header .card-title {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0;
}

/* Card header enhanced styling */
.card-header-enhanced {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #dee2e6;
    padding: 15px 20px;
}

.card-header-enhanced .card-title {
    margin: 0;
    font-weight: 600;
    color: #495057;
}

/* Statistics refresh styling */
.stats-refresh {
    position: relative;
    overflow: hidden;
}

.stats-refresh.shimmer::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* Statistics boxes improvements */
.small-box {
    border-radius: 10px;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.small-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.small-box .inner {
    padding: 20px;
}

.small-box .inner h3 {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.small-box .inner p {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 0;
    opacity: 0.9;
}

.small-box .icon {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 3rem;
    opacity: 0.3;
}
</style>
{% endblock extra_css %}
{% block content %}
    <section class="content">
        <div class="container-fluid">
            <!-- Statistik Admin -->
            <div class="row mb-4">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info stats-refresh" id="totalUsersStats">
                        <div class="inner">
                            <h3>{{ total_users }}</h3>
                            <p>Total Pengguna</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success stats-refresh" id="activeUsersStats">
                        <div class="inner">
                            <h3>{{ active_users }}</h3>
                            <p>Pengguna Aktif</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning stats-refresh" id="adminUsersStats">
                        <div class="inner">
                            <h3>{{ admin_users }}</h3>
                            <p>Administrator</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-danger stats-refresh" id="inactiveUsersStats">
                        <div class="inner">
                            <h3>{{ inactive_users }}</h3>
                            <p>Pengguna Nonaktif</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-user-times"></i>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Header Admin Panel -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="card" role="region" aria-labelledby="admin-header">
                        <div class="card-header">
                            <h3 class="card-title" id="admin-header">Kelola Pengguna</h3>
                            <div class="card-tools">
                                <button type="button"
                                        class="btn btn-primary"
                                        data-toggle="modal"
                                        data-target="#addUserModal"
                                        aria-label="Tambah pengguna baru">
                                    <i class="fas fa-plus" aria-hidden="true"></i> Tambah Pengguna
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tabel Pengguna -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card user-management-table" role="region" aria-labelledby="user-table-header">
                        <div class="card-header card-header-enhanced">
                            <h3 class="card-title" id="user-table-header">
                                <i class="fas fa-users mr-2" aria-hidden="true"></i>
                                Daftar Pengguna
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-primary btn-sm" onclick="refreshStats()" aria-label="Refresh data pengguna">
                                    <i class="fas fa-sync-alt" id="refreshIcon" aria-hidden="true"></i>
                                    Refresh
                                </button>
                                <span class="badge bg-info ml-2" role="status" aria-label="Total {{ users|length }} pengguna">
                                    <i class="fas fa-user-friends mr-1" aria-hidden="true"></i>
                                    Total: {{ users|length }} pengguna
                                </span>
                            </div>
                        </div>
                        <div class="card-body table-responsive p-0">
                            <table class="table table-hover text-nowrap" role="table" aria-labelledby="user-table-header" aria-describedby="user-table-description">
                                <caption id="user-table-description" class="sr-only">Tabel daftar pengguna dengan informasi ID, username, email, role, status, dan aksi yang dapat dilakukan</caption>
                                <thead>
                                    <tr role="row">
                                        <th scope="col" style="width: 60px;">
                                            <i class="fas fa-hashtag mr-1" aria-hidden="true"></i>
                                            ID
                                        </th>
                                        <th scope="col" style="width: 150px;">
                                            <i class="fas fa-user mr-1" aria-hidden="true"></i>
                                            Username
                                        </th>
                                        <th scope="col" style="width: 200px;">
                                            <i class="fas fa-envelope mr-1" aria-hidden="true"></i>
                                            Email
                                        </th>
                                        <th scope="col" style="width: 120px;">
                                            <i class="fas fa-user-tag mr-1" aria-hidden="true"></i>
                                            Role
                                        </th>
                                        <th scope="col" style="width: 100px;">
                                            <i class="fas fa-toggle-on mr-1" aria-hidden="true"></i>
                                            Status
                                        </th>
                                        <th scope="col" style="width: 150px;">
                                            <i class="fas fa-clock mr-1" aria-hidden="true"></i>
                                            Terakhir Login
                                        </th>
                                        <th scope="col" style="width: 150px;">
                                            <i class="fas fa-calendar-plus mr-1" aria-hidden="true"></i>
                                            Tanggal Daftar
                                        </th>
                                        <th scope="col" style="width: 180px;">
                                            <i class="fas fa-cogs mr-1" aria-hidden="true"></i>
                                            Aksi
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                        <tr role="row">
                                            <td class="text-center">
                                                <span class="badge badge-light" aria-label="ID pengguna {{ user.id }}">#{{ user.id }}</span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="user-avatar mr-2">
                                                        <i class="fas fa-user-circle fa-2x text-muted" aria-hidden="true"></i>
                                                    </div>
                                                    <div>
                                                        <strong>{{ user.username }}</strong>
                                                        {% if user.id == current_user.id %}
                                                            <span class="badge bg-info ml-1" aria-label="Akun Anda saat ini">
                                                                <i class="fas fa-star mr-1" aria-hidden="true"></i>Anda
                                                            </span>
                                                        {% endif %}
                                                        {% if user.full_name %}
                                                            <br><small class="text-muted">{{ user.full_name }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-at text-muted mr-2" aria-hidden="true"></i>
                                                    <span>{{ user.email }}</span>
                                                </div>
                                            </td>
                                            <td>
                                                {% if user.role == 'admin' %}
                                                    <span class="badge bg-danger" aria-label="Role Administrator">
                                                        <i class="fas fa-crown mr-1" aria-hidden="true"></i>Administrator
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-primary" aria-label="Role User">
                                                        <i class="fas fa-user mr-1" aria-hidden="true"></i>User
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if user.is_active %}
                                                    <span class="badge bg-success" aria-label="Status Aktif">
                                                        <i class="fas fa-check-circle mr-1" aria-hidden="true"></i>Aktif
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary" aria-label="Status Nonaktif">
                                                        <i class="fas fa-times-circle mr-1" aria-hidden="true"></i>Nonaktif
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if user.last_login %}
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-history text-success mr-2" aria-hidden="true"></i>
                                                        <div>
                                                            <small>{{ user.last_login | format_datetime }}</small>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-minus-circle text-muted mr-2" aria-hidden="true"></i>
                                                        <span class="text-muted">Belum pernah</span>
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-calendar text-info mr-2" aria-hidden="true"></i>
                                                    <small>{{ user.created_at | format_datetime }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button type="button"
                                                            class="btn btn-sm btn-info"
                                                            onclick="viewUser({{ user.id }})"
                                                            title="Lihat Detail">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    {% if user.id != current_user.id %}
                                                        <button type="button"
                                                                class="btn btn-sm btn-warning"
                                                                onclick="editUser({{ user.id }})"
                                                                title="Edit Pengguna">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        {% if user.is_active %}
                                                            <button type="button"
                                                                    class="btn btn-sm btn-secondary"
                                                                    onclick="toggleUserStatus({{ user.id }}, false)"
                                                                    title="Nonaktifkan">
                                                                <i class="fas fa-user-slash"></i>
                                                            </button>
                                                        {% else %}
                                                            <button type="button"
                                                                    class="btn btn-sm btn-success"
                                                                    onclick="toggleUserStatus({{ user.id }}, true)"
                                                                    title="Aktifkan">
                                                                <i class="fas fa-user-check"></i>
                                                            </button>
                                                        {% endif %}
                                                        <button type="button"
                                                                class="btn btn-sm btn-danger"
                                                                onclick="deleteUser({{ user.id }})"
                                                                title="Hapus Pengguna">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    {% else %}
                                                        <span class="badge badge-light">
                                                            <i class="fas fa-lock mr-1"></i>Akun Anda
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% else %}
                                        <tr>
                                            <td colspan="8" class="empty-state">
                                                <div>
                                                    <i class="fas fa-users fa-4x"></i>
                                                    <h5>Tidak ada pengguna yang ditemukan</h5>
                                                    <p>Belum ada pengguna yang terdaftar dalam sistem.</p>
                                                    <button type="button"
                                                            class="btn btn-primary mt-3"
                                                            data-toggle="modal"
                                                            data-target="#addUserModal">
                                                        <i class="fas fa-plus mr-2"></i>Tambah Pengguna Pertama
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if users|length > 0 %}
                        <div class="card-footer">
                            <div class="row align-items-center">
                                <div class="col-sm-6">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Menampilkan {{ users|length }} pengguna
                                    </small>
                                </div>
                                <div class="col-sm-6 text-right">
                                    <small class="text-muted">
                                        <i class="fas fa-clock mr-1"></i>
                                        Terakhir diperbarui: {{ current_time | format_datetime('datetime') }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Modal Tambah Pengguna -->
    <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Tambah Pengguna Baru</h4>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>×</span>
                    </button>
                </div>
                <form id="addUserForm">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="addUsername">Username</label>
                            <input type="text"
                                   class="form-control"
                                   id="addUsername"
                                   name="username"
                                   required>
                        </div>
                        <div class="form-group">
                            <label for="addEmail">Email</label>
                            <input type="email" class="form-control" id="addEmail" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="addPassword">Password</label>
                            <input type="password"
                                   class="form-control"
                                   id="addPassword"
                                   name="password"
                                   required>
                        </div>
                        <div class="form-group">
                            <label for="addRole">Role</label>
                            <select class="form-control" id="addRole" name="role" required>
                                <option value="user">User</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox"
                                       class="custom-control-input"
                                       id="addIsActive"
                                       name="is_active"
                                       checked>
                                <label class="custom-control-label" for="addIsActive">Aktif</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Tambah Pengguna</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal Edit Pengguna -->
    <div class="modal fade" id="editUserModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Edit Pengguna</h4>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>×</span>
                    </button>
                </div>
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" name="user_id">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="editUsername">Username</label>
                            <input type="text"
                                   class="form-control"
                                   id="editUsername"
                                   name="username"
                                   required>
                        </div>
                        <div class="form-group">
                            <label for="editEmail">Email</label>
                            <input type="email"
                                   class="form-control"
                                   id="editEmail"
                                   name="email"
                                   required>
                        </div>
                        <div class="form-group">
                            <label for="editPassword">Password Baru (kosongkan jika tidak ingin mengubah)</label>
                            <input type="password"
                                   class="form-control"
                                   id="editPassword"
                                   name="password">
                        </div>
                        <div class="form-group">
                            <label for="editRole">Role</label>
                            <select class="form-control" id="editRole" name="role" required>
                                <option value="user">User</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox"
                                       class="custom-control-input"
                                       id="editIsActive"
                                       name="is_active">
                                <label class="custom-control-label" for="editIsActive">Aktif</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal Detail Pengguna -->
    <div class="modal fade" id="viewUserModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Detail Pengguna</h4>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>×</span>
                    </button>
                </div>
                <div class="modal-body" id="userDetailBody">
                    <!-- Content akan dimuat via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_js %}
<script>
// Fix dropdown visibility and functionality
$(document).ready(function() {
    // Ensure dropdowns are properly styled and functional
    $('select[name="role"], select[name="status"]').each(function() {
        $(this).css({
            'position': 'relative',
            'z-index': '9999',
            'background-color': '#ffffff',
            'border': '1px solid #ced4da',
            'height': '38px',
            'min-height': '38px'
        });
    });
    
    // Handle dropdown focus to ensure visibility
    $('select[name="role"], select[name="status"]').on('focus', function() {
        $(this).css('z-index', '10000');
        $(this).parent().css('overflow', 'visible');
        $(this).closest('.card-body').css('overflow', 'visible');
        $(this).closest('.card').css('overflow', 'visible');
    });
    
    // Handle dropdown blur
    $('select[name="role"], select[name="status"]').on('blur', function() {
        $(this).css('z-index', '9999');
    });
    
    // Force container overflow to be visible
    $('.card-body, .card, .form-group').css('overflow', 'visible');
    
    // Ensure form elements have consistent height
    $('.form-control, .btn').css({
        'height': '38px',
        'min-height': '38px',
        'line-height': '1.5',
        'padding': '6px 12px'
    });
    
    // Handle form submission
    $('#filterForm').on('submit', function(e) {
        // Form akan submit secara normal ke server
    });
    
    // Handle reset button click
    $('.btn-secondary[href*="admin_panel"]').on('click', function(e) {
        e.preventDefault();
        // Clear all form fields
        $('#filterForm')[0].reset();
        $('select[name="role"]').val('');
        $('select[name="status"]').val('');
        $('input[name="search"]').val('');
        // Redirect to clean admin panel
        window.location.href = $(this).attr('href');
    });
    
    // Handle search button functionality
    $('.btn-primary[type="submit"]').on('click', function() {
        // Form akan submit secara otomatis
    });
});
</script>
<script>
// Add User
$('#addUserForm').submit(function(e) {
    e.preventDefault();
    
    var formData = new FormData();
    formData.append('username', $('#addUsername').val());
    formData.append('email', $('#addEmail').val());
    formData.append('password', $('#addPassword').val());
    formData.append('role', $('#addRole').val());
    formData.append('is_active', $('#addIsActive').is(':checked') ? 'true' : 'false');
    
    const csrfToken = $('meta[name=csrf-token]').attr('content');
    
    $.ajax({
        url: '/api/admin/users',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(response) {
            if (response.success) {
                Swal.fire('Berhasil', 'Pengguna berhasil ditambahkan', 'success').then(() => {
                    $('#addUserModal').modal('hide');
                    location.reload();
                });
            } else {
                Swal.fire('Error', response.message || 'Gagal menambahkan pengguna', 'error');
            }
        },
        error: function(xhr) {
            var errorMsg = 'Gagal menambahkan pengguna';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            }
            Swal.fire('Error', errorMsg, 'error');
        }
    });
});

// View User Detail
function viewUser(userId) {
    $.get('/api/admin/users/' + userId, function(data) {
        var content = `
            <div class="row">
                <div class="col-md-6">
                    <strong>ID:</strong> ${data.id}<br>
                    <strong>Username:</strong> ${data.username}<br>
                    <strong>Email:</strong> ${data.email}<br>
                    <strong>Role:</strong> ${data.role === 'admin' ? 'Administrator' : 'User'}<br>
                    <strong>Status:</strong> ${data.is_active ? 'Aktif' : 'Nonaktif'}<br>
                </div>
                <div class="col-md-6">
                    <strong>Tanggal Daftar:</strong> ${data.created_at || '-'}<br>
                    <strong>Terakhir Login:</strong> ${data.last_login || 'Belum pernah'}<br>
                    <strong>Total Upload:</strong> ${data.stats.total_uploads || 0}<br>
                    <strong>Total Scraping:</strong> ${data.stats.total_scraping || 0}<br>
                    <strong>Total Klasifikasi:</strong> ${data.stats.total_classifications || 0}<br>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-12">
                    <h5>Aktivitas Terbaru</h5>
                    <div class="timeline">
                        ${data.recent_activities.map(activity => `
                            <div class="time-label">
                                <span class="bg-info">${activity.created_at ? activity.created_at.split(' ')[0] : '-'}</span>
                            </div>
                            <div>
                                <i class="fas ${activity.icon} bg-${activity.color}"></i>
                                <div class="timeline-item">
                                    <span class="time"><i class="fas fa-clock"></i> ${activity.created_at ? activity.created_at.split(' ')[1] + ' ' + activity.created_at.split(' ')[2] : '-'}</span>
                                    <h3 class="timeline-header">${activity.title}</h3>
                                    <div class="timeline-body">${activity.description}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        $('#userDetailBody').html(content);
        $('#viewUserModal').modal('show');
    }).fail(function() {
        Swal.fire('Error', 'Gagal memuat detail pengguna', 'error');
    });
}

// Edit User
function editUser(userId) {
    $.get('/api/admin/users/' + userId, function(data) {
        $('#editUserId').val(data.id);
        $('#editUsername').val(data.username);
        $('#editEmail').val(data.email);
        $('#editRole').val(data.role);
        $('#editIsActive').prop('checked', data.is_active);
        $('#editUserModal').modal('show');
    }).fail(function() {
        Swal.fire('Error', 'Gagal memuat data pengguna', 'error');
    });
}

$('#editUserForm').submit(function(e) {
    e.preventDefault();
    
    var userId = $('#editUserId').val();
    var formData = new FormData();
    formData.append('username', $('#editUsername').val());
    formData.append('email', $('#editEmail').val());
    formData.append('role', $('#editRole').val());
    formData.append('is_active', $('#editIsActive').is(':checked') ? 'true' : 'false');
    
    if ($('#editPassword').val()) {
        formData.append('password', $('#editPassword').val());
    }
    
    const csrfToken = $('meta[name=csrf-token]').attr('content');
    
    $.ajax({
        url: '/api/admin/users/' + userId,
        type: 'PUT',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': csrfToken
        },
        success: function(response) {
            if (response.success) {
                Swal.fire('Berhasil', 'Pengguna berhasil diperbarui', 'success').then(() => {
                    $('#editUserModal').modal('hide');
                    location.reload();
                });
            } else {
                Swal.fire('Error', response.message || 'Gagal memperbarui pengguna', 'error');
            }
        },
        error: function(xhr) {
            var errorMsg = 'Gagal memperbarui pengguna';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            }
            Swal.fire('Error', errorMsg, 'error');
        }
    });
});

// Toggle User Status
function toggleUserStatus(userId, status) {
    var action = status ? 'mengaktifkan' : 'menonaktifkan';
    
    Swal.fire({
        title: 'Konfirmasi',
        text: `Apakah Anda yakin ingin ${action} pengguna ini?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Ya, ' + action.charAt(0).toUpperCase() + action.slice(1),
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            const csrfToken = $('meta[name=csrf-token]').attr('content');
            var formData = new FormData();
            formData.append('is_active', status ? 'true' : 'false');
            
            $.ajax({
                url: '/api/admin/users/' + userId + '/toggle-status',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire('Berhasil', `Pengguna berhasil ${status ? 'diaktifkan' : 'dinonaktifkan'}`, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', response.message || 'Gagal mengubah status pengguna', 'error');
                    }
                },
                error: function(xhr) {
                    var errorMsg = 'Gagal mengubah status pengguna';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    Swal.fire('Error', errorMsg, 'error');
                }
            });
        }
    });
}

function refreshStats() {
    // Animate refresh icon
    const refreshIcon = document.getElementById('refreshIcon');
    refreshIcon.classList.add('fa-spin');
    
    // Add shimmer effect to all stats boxes
    const statsBoxes = document.querySelectorAll('.stats-refresh');
    statsBoxes.forEach(box => {
        box.classList.add('shimmer');
    });
    
    // Simulate refresh (in real implementation, this would be an AJAX call)
    setTimeout(() => {
        refreshIcon.classList.remove('fa-spin');
        statsBoxes.forEach(box => {
            box.classList.remove('shimmer');
        });
        
        // Reload the page to get fresh data
        location.reload();
    }, 1500);
}

// Delete User
function deleteUser(userId) {
    Swal.fire({
        title: 'Konfirmasi Hapus',
        text: 'Apakah Anda yakin ingin menghapus pengguna ini? Tindakan ini tidak dapat dibatalkan.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, Hapus',
        cancelButtonText: 'Batal',
        confirmButtonColor: '#d33'
    }).then((result) => {
        if (result.isConfirmed) {
            const csrfToken = $('meta[name=csrf-token]').attr('content');
            $.ajax({
                url: '/api/admin/users/' + userId,
                type: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire('Berhasil', 'Pengguna berhasil dihapus', 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error', response.message || 'Gagal menghapus pengguna', 'error');
                    }
                },
                error: function(xhr) {
                    var errorMsg = 'Gagal menghapus pengguna';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    Swal.fire('Error', errorMsg, 'error');
                }
            });
        }
    });
}


</script>
{% endblock extra_js %}
