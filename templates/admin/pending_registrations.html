{% extends "base.html" %}

{% block title %}Permintaan Registrasi - Admin Panel{% endblock %}

{% block page_title %}
    Permintaan Registrasi
{% endblock page_title %}

{% block breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{{ url_for("dashboard") }}">Home</a>
    </li>
    <li class="breadcrumb-item active">Permintaan Registrasi</li>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
/* Konsistensi dengan Admin Panel */
.card-body {
    overflow: visible !important;
    position: relative !important;
    z-index: 1 !important;
}

.form-group {
    overflow: visible !important;
    position: relative !important;
    z-index: 2 !important;
}

/* Konsistensi ukuran untuk semua elemen form */
.form-control, .btn {
    height: 38px !important;
    min-height: 38px !important;
    line-height: 1.5 !important;
    padding: 6px 12px !important;
    font-size: 14px !important;
    border-radius: 4px !important;
}

/* Button consistency */
.btn-block {
    width: 100% !important;
    height: 38px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* Consistent Table Styling */
.user-management-table {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.user-management-table .table {
    margin-bottom: 0;
    border-collapse: separate;
    border-spacing: 0;
}

.user-management-table .table thead th {
    background: linear-gradient(135deg, #343a40 0%, #495057 100%);
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.5px;
    border: none;
    padding: 15px 12px;
    position: sticky;
    top: 0;
    z-index: 10;
}

.user-management-table .table tbody tr {
    transition: all 0.2s ease;
    border-bottom: 1px solid #e9ecef;
}

.user-management-table .table tbody tr:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.user-management-table .table tbody tr:nth-child(even) {
    background-color: #fdfdfd;
}

.user-management-table .table tbody tr:nth-child(even):hover {
    background-color: #f8f9fa;
}

.user-management-table .table tbody td {
    padding: 12px;
    vertical-align: middle;
    border-top: none;
    font-size: 14px;
}

/* Status badges */
.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: #ffffff !important;
    border: 1px solid #dee2e6;
}

.status-pending {
    background: #ffffff !important;
    color: #ffc107 !important;
    border: 1px solid #ffc107;
}

.status-expired {
    background: #ffffff !important;
    color: #dc3545 !important;
    border: 1px solid #dc3545;
}

.status-approved {
    background: #ffffff !important;
    color: #28a745 !important;
    border: 1px solid #28a745;
}

.status-rejected {
    background: #ffffff !important;
    color: #6c757d !important;
    border: 1px solid #6c757d;
}

/* Action buttons */
.action-buttons {
    display: flex;
    gap: 4px;
    justify-content: center;
}

.action-buttons .btn {
    padding: 6px 10px;
    font-size: 12px;
    border-radius: 4px;
    transition: all 0.2s ease;
    border: none;
}

.action-buttons .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

/* Card header styling */
.card-header-enhanced {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #dee2e6;
    padding: 15px 20px;
}

.card-header-enhanced .card-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Statistics refresh indicator */
.stats-refresh {
    position: relative;
    overflow: hidden;
}

.stats-refresh.refreshing::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .user-management-table .table thead th {
        font-size: 10px;
        padding: 10px 8px;
    }
    
    .user-management-table .table tbody td {
        padding: 8px;
        font-size: 12px;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 2px;
    }
    
    .action-buttons .btn {
        font-size: 10px;
        padding: 4px 8px;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning stats-refresh" id="pendingStats">
            <div class="inner">
                <h3 id="pendingCount">{{ pending_requests|length }}</h3>
                <p>Pending</p>
            </div>
            <div class="icon">
                <i class="fas fa-clock"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success stats-refresh" id="approvedStats">
            <div class="inner">
                <h3 id="approvedCount">0</h3>
                <p>Approved</p>
            </div>
            <div class="icon">
                <i class="fas fa-check"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-danger stats-refresh" id="rejectedStats">
            <div class="inner">
                <h3 id="rejectedCount">0</h3>
                <p>Rejected</p>
            </div>
            <div class="icon">
                <i class="fas fa-times"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info stats-refresh" id="totalStats">
            <div class="inner">
                <h3 id="totalCount">0</h3>
                <p>Total</p>
            </div>
            <div class="icon">
                <i class="fas fa-users"></i>
            </div>
        </div>
    </div>
</div>

<!-- Registration Requests Table -->
<div class="row">
    <div class="col-12">
        <div class="card user-management-table">
            <div class="card-header card-header-enhanced">
                <h3 class="card-title">
                    <i class="fas fa-clock"></i>
                    Daftar Permintaan Registrasi
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-primary btn-sm" onclick="refreshStatsButton()">
                        <i class="fas fa-sync-alt" id="refreshIcon"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if pending_requests %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th style="width: 60px;">
                                    <i class="fas fa-hashtag mr-1"></i>
                                    ID
                                </th>
                                <th style="width: 150px;">
                                    <i class="fas fa-user mr-1"></i>
                                    Username
                                </th>
                                <th style="width: 200px;">
                                    <i class="fas fa-envelope mr-1"></i>
                                    Email
                                </th>
                                <th style="width: 120px;">
                                    <i class="fas fa-id-card mr-1"></i>
                                    Nama Lengkap
                                </th>
                                <th style="width: 140px;">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    Waktu Registrasi
                                </th>
                                <th style="width: 100px;">
                                    <i class="fas fa-shield-alt mr-1"></i>
                                    Status OTP
                                </th>
                                <th style="width: 180px;" class="text-center">
                                    <i class="fas fa-cogs mr-1"></i>
                                    Aksi
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in pending_requests %}
                            <tr>
                                <td><strong>{{ request.id }}</strong></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user text-primary mr-2"></i>
                                        <span>{{ request.username }}</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-envelope text-info mr-2"></i>
                                        <span class="text-truncate" style="max-width: 180px;" title="{{ request.email }}">{{ request.email }}</span>
                                    </div>
                                </td>
                                <td>
                                    {% if request.full_name %}
                                        <span class="text-truncate" style="max-width: 100px;" title="{{ request.full_name }}">{{ request.full_name }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-alt mr-1"></i>
                                        {{ request.created_at.strftime('%d/%m/%Y') }}<br>
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ request.created_at.strftime('%H:%M') }}
                                    </small>
                                </td>
                                <td>
                                    {% if request.otp_expires_at and datetime.utcnow() > request.otp_expires_at %}
                                        <span class="status-badge status-expired">
                                            <i class="fas fa-times-circle"></i>
                                            Expired
                                        </span>
                                    {% else %}
                                        <span class="status-badge status-approved">
                                            <i class="fas fa-check-circle"></i>
                                            Valid
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="action-buttons">
                                        <a href="{{ url_for('otp.approve_registration', request_id=request.id) }}" 
                                           class="btn btn-success" title="Approve Registration">
                                            <i class="fas fa-check"></i>
                                        </a>
                                        <button onclick="resendOTP({{ request.id }})" 
                                                class="btn btn-warning" title="Resend OTP">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                        <button onclick="deleteRequest({{ request.id }})" 
                                                class="btn btn-danger" title="Delete Request">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                                class="btn btn-danger" title="Delete Request">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Tidak ada permintaan registrasi pending</h5>
                    <p class="text-muted">Semua permintaan registrasi telah diproses.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

            <!-- Quick Actions -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <a href="{{ url_for('otp.registration_history') }}" class="btn btn-info btn-block">
                                        <i class="fas fa-history mr-2"></i>
                                        Riwayat Registrasi
                                    </a>
                                </div>
                                <div class="col-md-4">
                                    <button onclick="refreshStatsButton()" class="btn btn-warning btn-block">
                                        <i class="fas fa-sync-alt mr-2"></i>
                                        Refresh Statistik
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-block">
                                        <i class="fas fa-arrow-left mr-2"></i>
                                        Kembali ke Dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Load statistics
    refreshStats();
    
    // Auto refresh every 60 seconds (reduced frequency)
    setInterval(function() {
        if (!document.hidden) {
            refreshStats();
        }
    }, 60000);
});

function refreshStats() {
    $.get('{{ url_for("otp.registration_stats") }}')
        .done(function(data) {
            $('#pendingCount').text(data.pending || 0);
            $('#approvedCount').text(data.approved || 0);
            $('#rejectedCount').text(data.rejected || 0);
            $('#totalCount').text(data.total || 0);
        })
        .fail(function() {
            console.error('Failed to load statistics');
        });
}

function deleteRequest(requestId) {
    Swal.fire({
        title: 'Konfirmasi Hapus',
        text: 'Apakah Anda yakin ingin menghapus permintaan registrasi ini? Tindakan ini tidak dapat dibatalkan.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Hapus!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            const csrfToken = $('meta[name=csrf-token]').attr('content');
            $.ajax({
                url: '{{ url_for("otp.delete_registration_request", request_id=0) }}'.replace('0', requestId),
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire('Berhasil!', response.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error!', 'Gagal menghapus permintaan: ' + response.message, 'error');
                    }
                },
                error: function() {
                    Swal.fire('Error!', 'Terjadi kesalahan sistem', 'error');
                }
            });
        }
    });
}

function refreshStatsButton() {
    const refreshIcon = document.getElementById('refreshIcon');
    const statsBoxes = document.querySelectorAll('.stats-refresh');
    
    // Add refreshing animation
    refreshIcon.classList.add('fa-spin');
    statsBoxes.forEach(box => box.classList.add('refreshing'));
    
    // Call the actual refresh function
    refreshStats();
    
    // Remove animations after a delay
    setTimeout(() => {
        refreshIcon.classList.remove('fa-spin');
        statsBoxes.forEach(box => box.classList.remove('refreshing'));
    }, 1500);
}

function resendOTP(requestId) {
    Swal.fire({
        title: 'Konfirmasi Resend OTP',
        text: 'Apakah Anda yakin ingin mengirim ulang OTP untuk permintaan ini?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Ya, Kirim Ulang!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            const csrfToken = $('meta[name=csrf-token]').attr('content');
            $.ajax({
                url: '{{ url_for("otp.resend_otp", request_id=0) }}'.replace('0', requestId),
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire('Berhasil!', response.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Error!', 'Gagal mengirim OTP: ' + response.message, 'error');
                    }
                },
                error: function() {
                    Swal.fire('Error!', 'Terjadi kesalahan sistem', 'error');
                }
            });
        }
    });
}
</script>
{% endblock %}