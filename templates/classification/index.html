{% extends "base.html" %}

{% block title %} Klasifikasi {% endblock title %}

{% block stylesheets %}
<style>
    .small-box {
        position: relative;
        display: block;
        margin-bottom: 20px;
        box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
        border-radius: 0.25rem;
        overflow: hidden;
    }

    .small-box > .inner {
        padding: 20px;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .small-box h3 {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 0 0 10px 0;
        white-space: nowrap;
        padding: 0;
    }

    .small-box p {
        font-size: 1rem;
        margin-bottom: 0;
    }

    .small-box .icon {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 60px;
        color: rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .small-box:hover .icon {
        transform: scale(1.1);
    }

    .small-box .small-box-footer {
        position: relative;
        text-align: center;
        padding: 3px 0;
        color: #fff;
        display: block;
        z-index: 10;
        background: rgba(0,0,0,0.1);
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .small-box .small-box-footer:hover {
        background: rgba(0,0,0,0.15);
    }

    .bg-warning-dark {
        background-color: #e0a800 !important;
    }

    .bg-info-dark {
        background-color: #0f7b88 !important;
    }

    .card {
        margin-bottom: 1rem;
        box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .card-outline {
        border-top: 3px solid;
    }

    .card-outline.card-primary {
        border-top-color: #007bff;
    }

    .card-outline.card-success {
        border-top-color: #28a745;
    }

    .card-header {
        padding: 0.75rem 1.25rem;
        background-color: rgba(0,0,0,.03);
    }

    .card-body {
        padding: 1.5rem;
    }

    .card-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        line-height: 1.2;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
        border-radius: 0.3rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease-in-out;
        min-width: 160px;
    }

    .btn-lg i {
        font-size: 1.2rem;
    }

    .btn-lg:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .card-body p {
        color: #6c757d;
        line-height: 1.5;
        font-size: 1rem;
    }

    .mt-4 {
        margin-top: 2rem !important;
    }

    .px-5 {
        padding-left: 3rem !important;
        padding-right: 3rem !important;
    }

    /* Modal dan Tabel Styles */
    .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - 1rem);
    }

    .modal-content {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }

    .table {
        margin-bottom: 0;
    }

    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }

    .table td {
    vertical-align: middle;
    padding: 0.75rem;
}

.table td.text-wrap {
    white-space: normal;
    min-width: 200px;
}

.table td .text-break {
    word-break: break-word;
    max-height: 100px;
    overflow-y: auto;
    padding-right: 5px;
}

/* Styling untuk scrollbar */
.text-break::-webkit-scrollbar {
    width: 4px;
}

.text-break::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.text-break::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 2px;
}

.text-break::-webkit-scrollbar-thumb:hover {
    background: #555;
}

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
    }</style>
{% endblock stylesheets %}

{% block page_title %}
    Klasifikasi Data
{% endblock page_title %}

{% block breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{{ url_for('dashboard') }}">Home</a>
    </li>
    <li class="breadcrumb-item active">Klasifikasi</li>
{% endblock breadcrumb %}

{% block content %}
    <section class="content">
        <div class="container-fluid">
            <!-- Overview Cards -->
            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-primary">
                        <div class="inner">
                            <h3>{{ clean_upload_count or 0 }}</h3>
                            <p>Data Upload Bersih</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <a href="#" class="small-box-footer" onclick="showUploadData()">
                            Lihat Detail <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3>{{ clean_scraper_count or 0 }}</h3>
                            <p>Data Scraper Bersih</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-spider"></i>
                        </div>
                        <a href="#" class="small-box-footer" onclick="showScraperData()">
                            Lihat Detail <i class="fas fa-arrow-circle-right"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3 class="text-dark">{{ total_data_count or 0 }}</h3>
                            <p class="text-dark">Total Data Siap</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="small-box-footer bg-warning-dark">
                            &nbsp;
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3>{{ classified_count or 0 }}</h3>
                            <p>Sudah Diklasifikasi</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="small-box-footer bg-info-dark">
                            &nbsp;
                        </div>
                    </div>
                </div>
            </div>

            <!-- Classification Options -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-brain mr-2"></i>Pilih Jenis Klasifikasi
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card card-outline card-primary h-100">
                                        <div class="card-header">
                                            <h5 class="card-title">
                                                <i class="fas fa-list mr-2"></i>Klasifikasi Batch
                                            </h5>
                                        </div>
                                        <div class="card-body d-flex flex-column">
                                            <p class="flex-grow-1 mb-4">Klasifikasi data secara otomatis menggunakan model ML.</p>
                                            <div class="text-center">
                                                <a href="{{ url_for('classify_data', data_type='batch', data_id=0) }}" class="btn btn-primary btn-lg px-5">
                                                    <i class="fas fa-play mr-2"></i>Mulai Batch
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card card-outline card-success h-100">
                                        <div class="card-header">
                                            <h5 class="card-title">
                                                <i class="fas fa-edit mr-2"></i>Klasifikasi Manual
                                            </h5>
                                        </div>
                                        <div class="card-body d-flex flex-column">
                                            <p class="flex-grow-1 mb-4">Klasifikasi data satu per satu secara manual.</p>
                                            <div class="text-center">
                                                <a href="{{ url_for('classify', type='manual') }}" class="btn btn-success btn-lg px-5">
                                                    <i class="fas fa-keyboard mr-2"></i>Mulai Manual
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal untuk Lihat Detail -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="detailModalTitle">Detail Data</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover table-striped" id="detailTable">
                            <thead class="thead-light">
                                <tr>
                                <th class="text-center" style="width: 5%">ID</th>
                                <th class="text-center" style="width: 10%">Dataset</th>
                                <th class="text-center" style="width: 8%">Platform</th>
                                <th class="text-center" style="width: 10%">Username</th>
                                <th class="text-center" style="width: 22%">Konten Asli</th>
                                <th class="text-center" style="width: 22%">Konten Bersih</th>
                                <th class="text-center" style="width: 13%">Tanggal</th>
                                <th class="text-center" style="width: 10%">Aksi</th>
                            </tr>
                            </thead>
                            <tbody id="detailTableBody" class="align-middle">
                                <!-- Data akan diisi melalui JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block scripts %}
<script>
function showUploadData() {
    loadDetailData('upload');
}

function showScraperData() {
    loadDetailData('scraper');
}

function loadDetailData(type) {
    $('#detailModalTitle').text(type === 'upload' ? 'Data Upload Bersih' : 'Data Scraper Bersih');
    $('#detailTableBody').html('<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data...</td></tr>');
    $('#detailModal').modal('show');
    
    // Ambil data dari API
    $.ajax({
        url: `/api/clean_data/${type}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                let tableHtml = '';
                response.data.forEach(data => {
                    tableHtml += `
                        <tr>
                            <td class="text-center align-middle">${data.id}</td>
                            <td class="text-center align-middle">${data.dataset_name || '-'}</td>
                            <td class="text-center align-middle">${data.platform || '-'}</td>
                            <td class="text-center align-middle">${data.username || '-'}</td>
                            <td class="align-middle text-wrap" style="max-width: 250px;">
                                <div class="text-break">${data.content || '-'}</div>
                            </td>
                            <td class="align-middle text-wrap" style="max-width: 250px;">
                                <div class="text-break">${data.cleaned_content || '-'}</div>
                            </td>
                            <td class="text-center align-middle">${data.created_at ? new Date(data.created_at).toLocaleString('id-ID') : '-'}</td>
                            <td class="text-center align-middle">
                                ${data.is_classified ? `
                                    <button class="btn btn-success btn-sm w-100" disabled>
                                        <i class="fas fa-check mr-1"></i>Sudah Diklasifikasi
                                    </button>
                                ` : `
                                    <button class="btn btn-primary btn-sm w-100" onclick="classifyData('${type}', ${data.id})">
                                        <i class="fas fa-tag mr-1"></i>Klasifikasi
                                    </button>
                                `}
                            </td>
                        </tr>
                    `;
                });
                
                if (tableHtml === '') {
                    tableHtml = '<tr><td colspan="7" class="text-center">Tidak ada data tersedia</td></tr>';
                }
                
                $('#detailTableBody').html(tableHtml);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: response.message || 'Gagal memuat data'
                });
            }
        },
        error: function() {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Terjadi kesalahan saat memuat data'
            });
        }
    });
}

function loadData(type) {
    $('#dataTablesContainer').removeClass('d-none');
    $('#dataTableBody').html('<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data...</td></tr>');
    
    // Simulate loading data
    setTimeout(() => {
        let tableHtml = '';
        if (type === 'upload') {
            {% for data in clean_upload_data %}
            tableHtml += `
                <tr>
                    <td class="text-center"><input type="checkbox" class="form-check-input data-checkbox" value="{{ data.id }}"></td>
                    <td>{{ data.id }}</td>
                    <td>Upload</td>
                    <td>{{ data.username if data.username else '-' }}</td>
                    <td>{{ data.cleaned_content[:50] }}{% if data.cleaned_content|length > 50 %}...{% endif %}</td>
                    <td>{{ data.created_at|format_datetime('date') if data.created_at else '-' }}</td>
                    <td><span class="badge badge-success">Dibersihkan</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="classifyData('upload', {{ data.id }})">
                            <i class="fas fa-brain"></i> Klasifikasi
                        </button>
                    </td>
                </tr>
            `;
            {% endfor %}
        } else {
            {% for data in clean_scraper_data %}
            tableHtml += `
                <tr>
                    <td class="text-center"><input type="checkbox" class="form-check-input data-checkbox" value="{{ data.id }}"></td>
                    <td>{{ data.id }}</td>
                    <td>Scraper</td>
                    <td>{{ data.username if data.username else '-' }}</td>
                    <td>{{ data.cleaned_content[:50] }}{% if data.cleaned_content|length > 50 %}...{% endif %}</td>
                    <td>{{ data.created_at|format_datetime('date') if data.created_at else '-' }}</td>
                    <td><span class="badge badge-success">Dibersihkan</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="classifyData('scraper', {{ data.id }})">
                            <i class="fas fa-brain"></i> Klasifikasi
                        </button>
                    </td>
                </tr>
            `;
            {% endfor %}
        }
        
        if (tableHtml === '') {
            tableHtml = '<tr><td colspan="8" class="text-center">Tidak ada data tersedia</td></tr>';
        }
        
        $('#dataTableBody').html(tableHtml);
        
        // Initialize select all checkbox functionality
        $('#selectAll').change(function() {
            $('.data-checkbox').prop('checked', this.checked);
        });
        
        // Update select all checkbox when individual checkboxes change
        $(document).on('change', '.data-checkbox', function() {
            const totalCheckboxes = $('.data-checkbox').length;
            const checkedCheckboxes = $('.data-checkbox:checked').length;
            $('#selectAll').prop('checked', totalCheckboxes === checkedCheckboxes);
        });
    }, 1000);
}

function showManualClassification() {
    $('#manualClassificationModal').modal('show');
}

function classifyData(type, id) {
    window.location.href = `/classification/classify/${type}/${id}`;
}

function classifyManualText() {
    const text = $('#manualText').val().trim();
    if (!text) {
        Swal.fire({
            icon: 'warning',
            title: 'Teks Kosong',
            text: 'Silakan masukkan teks yang ingin diklasifikasi'
        });
        return;
    }
    
    // Show loading
    Swal.fire({
        title: 'Mengklasifikasi...',
        text: 'Mohon tunggu, sedang memproses teks dengan 3 model',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Call API to classify text
    const csrfToken = $('meta[name=csrf-token]').attr('content');
    $.ajax({
        url: '/api/classify_manual_text',
        method: 'POST',
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': csrfToken
        },
        data: JSON.stringify({ text: text }),
        success: function(response) {
            if (response.success) {
                let resultsHtml = `
                    <div class="text-left">
                        <p><strong>Teks:</strong> "${response.text}"</p>
                        <hr>
                        <h6><strong>Hasil Klasifikasi dari 3 Model:</strong></h6>
                `;
                
                response.results.forEach((result, index) => {
                    const modelNum = index + 1;
                    const badgeClass = result.prediction === 'radikal' ? 'danger' : 'success';
                    const predictionText = result.prediction === 'radikal' ? 'Radikal' : 'Non-Radikal';
                    
                    resultsHtml += `
                        <div class="mb-3 p-2 border rounded">
                            <h6><strong>Model ${modelNum}:</strong></h6>
                            <p><strong>Prediksi:</strong> <span class="badge badge-${badgeClass} badge-lg">${predictionText}</span></p>
                            <p><strong>Probabilitas Radikal:</strong> ${(result.probability_radikal * 100).toFixed(2)}%</p>
                            <p><strong>Probabilitas Non-Radikal:</strong> ${(result.probability_non_radikal * 100).toFixed(2)}%</p>

                        </div>
                    `;
                });
                
                resultsHtml += '</div>';
                
                Swal.fire({
                    icon: 'success',
                    title: 'Hasil Klasifikasi',
                    html: resultsHtml,
                    showConfirmButton: true,
                    width: '600px'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: response.message
                });
            }
        },
        error: function(xhr, status, error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Terjadi kesalahan saat mengklasifikasi teks'
            });
        },
        complete: function() {
            $('#manualText').val('');
        }
    });
}

function classifySelectedDataset(datasetId) {
    Swal.fire({
        title: 'Konfirmasi Klasifikasi',
        text: 'Apakah Anda yakin ingin mengklasifikasi semua data dalam dataset ini?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, Klasifikasi!',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            // Show loading
            Swal.fire({
                title: 'Mengklasifikasi Dataset...',
                text: 'Mohon tunggu, sedang memproses data',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Call API to classify dataset
            const csrfToken = $('meta[name=csrf-token]').attr('content');
            $.ajax({
                url: `/api/dataset/${datasetId}/classify`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function(response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Klasifikasi Berhasil!',
                        text: `${response.classified_count} data berhasil diklasifikasi`,
                        showConfirmButton: true
                    }).then(() => {
                        // Redirect to results page
                        window.location.href = '/classification/results';
                    });
                },
                error: function(xhr) {
                    let errorMessage = 'Terjadi kesalahan saat mengklasifikasi data';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'Klasifikasi Gagal',
                        text: errorMessage
                    });
                }
            });
        }
    });
}
</script>
{% endblock scripts %}